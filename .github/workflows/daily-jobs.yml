name: Daily Jobs

on:
  # schedule:
  #   - cron: '0 21 * * *'  # Uncomment after setup (9pm UTC = 7am AEST)
  workflow_dispatch:
    inputs:
      full_run:
        description: 'Run full search matrix (all locations x all roles)'
        required: false
        default: 'false'
        type: boolean
      hours:
        description: 'Max hours since posted'
        required: false
        default: '24'
        type: string
      min_score:
        description: 'Minimum score for email digest (blank = use profile.json minScore)'
        required: false
        default: ''
        type: string

concurrency:
  group: daily-jobs
  cancel-in-progress: false

jobs:
  scrape-and-email:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: uv sync

      - name: Install Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Verify profile.json exists
        run: |
          if [ ! -f profile.json ]; then
            echo "::error::profile.json not found. Commit your profile.json to the repo root (see README)."
            exit 1
          fi

      - name: Run scraper (focused)
        if: ${{ !(inputs.full_run == true || inputs.full_run == 'true') }}
        env:
          CHROME_BINARY: /usr/bin/google-chrome-stable
          PYTHONUNBUFFERED: "1"
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1280x720x24" \
            uv run python scrape.py --profile profile.json --hours "${{ inputs.hours || '24' }}" --results 20

      - name: Run scraper (full)
        if: ${{ inputs.full_run == true || inputs.full_run == 'true' }}
        env:
          CHROME_BINARY: /usr/bin/google-chrome-stable
          PYTHONUNBUFFERED: "1"
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1280x720x24" \
            uv run python scrape.py --profile profile.json --hours 48

      - name: Read min score from profile
        id: profile-config
        run: |
          MIN_SCORE=$(python3 -c "import json; p=json.load(open('profile.json')); print(p.get('minScore', 20))" 2>/dev/null || echo "20")
          echo "min_score=$MIN_SCORE" >> "$GITHUB_OUTPUT"

      - name: Send email digest
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
        run: uv run python email_digest.py --min-score "${{ inputs.min_score || steps.profile-config.outputs.min_score || '20' }}"

      - name: Upload jobs artifact
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: jobs
          path: jobs/
          retention-days: 7
